---
title: "PHC 6937 (Data Visualization) Final Project"
author: "Jack Leary"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: journal
    highlight: tango
    df_print: kable
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    code_folding: show
    code_download: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      message = FALSE, 
                      warning = FALSE, 
                      fig.align = "center")
options(future.globals.maxSize = 2000 * 1024^2)
```

# Introduction

# Libaries

```{r}
library(dplyr)
library(Seurat)
library(ggpubr)
library(ggplot2)
library(SCISSORS)
library(patchwork)
library(paletteer)
library(kableExtra)
```

# Data

There are several samples here, so we'll need to create a dictionary of the samplenames and the sample types. 

```{r}
dir_names <- c("GSM4679532", "GSM4679533", "GSM4679534", "GSM4679535", "GSM4679536", 
               "GSM4679537", "GSM4679538", "GSM4679539", "GSM4679540", "GSM4679541", 
               "GSM4679542", "GSM4679543", "GSM4679544", "GSM4679545", "GSM4679546", "GSM4679547")
sample_names <- c("P01", "P02", "P03", "P04", "P05", "P06", "P07", "P08", "P09", "P10", 
                  "MET01", "MET02", "MET03", "MET04", "MET05", "MET06")
sample_types <- c(rep("Primary", 10), rep("Metastatic", 6))
sample_dict <- data.frame(Directory = dir_names, 
                          Sample = sample_names, 
                          Type = sample_types)
sample_dict %>% 
  kbl(booktabs = TRUE, caption = "Sample Dictionary") %>% 
  kable_minimal("hover", html_font = "Avenir", full_width = FALSE)
```

## Dataset Integration

First, we loop across the samples, create `Seurat` objects, and normalize expression and identify variable genes. The first 10 samples are primary tumors, and the next 6 are metastatic. 

```{r}
obj_list <- list()
for (i in seq(sample_dict$Directory)) {
  file <- paste0("~/Desktop/Data/Lin et al/GSE154778_RAW/", sample_dict$Directory[i])
  counts <- Read10X(file)
  seurat_obj <- CreateSeuratObject(counts, 
                                   project = sample_dict$Sample[i], 
                                   min.cells = 3, 
                                   min.features = 1000)
  seurat_obj@meta.data$sample <- sample_dict$Sample[i]
  seurat_obj <- SCTransform(seurat_obj, 
                            variable.features.n = 2000, 
                            seed.use = 629, 
                            verbose = FALSE)
  obj_list[[i]] <- seurat_obj
}
primary_obj <- obj_list[1:10]
meta_obj <- obj_list[11:16]
```

```{r, echo=FALSE}
rm(counts, obj_list, seurat_obj, dir_names, file, sample_names, sample_types)
```

Next we integrate all the samples into one `Seurat` object. We'll start with the primary samples. 

```{r}
integration_genes <- SelectIntegrationFeatures(object.list = primary_obj, 
                                               nfeatures = 2000, 
                                               verbose = FALSE)
primary_obj <- PrepSCTIntegration(object.list = primary_obj, 
                                  anchor.features = integration_genes, 
                                  verbose = FALSE)
integration_anchors <- FindIntegrationAnchors(object.list = primary_obj, 
                                              normalization.method = "SCT", 
                                              anchor.features = integration_genes)
primary_orig <- IntegrateData(anchorset = integration_anchors, 
                              normalization.method = "SCT", 
                              k.weight = 50,
                              verbose = FALSE)
DefaultAssay(primary_orig) <- "integrated"
```

And we repeat the process for the metastatic samples. 

```{r}
integration_genes <- SelectIntegrationFeatures(object.list = meta_obj, 
                                               nfeatures = 2000, 
                                               verbose = FALSE)
meta_obj <- PrepSCTIntegration(object.list = meta_obj, 
                               anchor.features = integration_genes, 
                               verbose = FALSE)
integration_anchors <- FindIntegrationAnchors(object.list = meta_obj, 
                                              normalization.method = "SCT", 
                                              anchor.features = integration_genes)
meta_orig <- IntegrateData(anchorset = integration_anchors, 
                           normalization.method = "SCT", 
                           k.weight = 50,
                           verbose = FALSE)
DefaultAssay(meta_orig) <- "integrated"
```

# Preprocessing

## Primary Tumors

```{r}
primary_orig <- RunPCA(primary_orig, 
                       npcs = 20, 
                       verbose = FALSE, 
                       seed.use = 629)
primary_orig <- RunUMAP(primary_orig, 
                        reduction = "pca", 
                        dims = 1:20, 
                        min.dist = 0.2, 
                        metric = "cosine", 
                        n.components = 2, 
                        seed.use = 629, 
                        verbose = FALSE)
primary_orig <- FindNeighbors(primary_orig, 
                              reduction = "pca", 
                              dims = 1:20, 
                              k.param = 40, 
                              verbose = FALSE)
primary_orig <- FindClusters(primary_orig, 
                             resolution = 0.3, 
                             random.seed = 629,
                             verbose = FALSE)
```

## Metastatic Tumors

Now we repeat the preprocessing on the metastatic tumors. 

```{r}
meta_orig <- RunPCA(meta_orig, 
                    npcs = 20, 
                    verbose = FALSE, 
                    seed.use = 629)
meta_orig <- RunUMAP(meta_orig, 
                     reduction = "pca", 
                     dims = 1:20, 
                     min.dist = 0.075, 
                     metric = "cosine", 
                     n.components = 2, 
                     seed.use = 629, 
                     verbose = FALSE)
meta_orig <- FindNeighbors(meta_orig, 
                           reduction = "pca", 
                           dims = 1:20, 
                           k.param = 50, 
                           verbose = FALSE)
meta_orig <- FindClusters(meta_orig, 
                          resolution = 0.3, 
                          verbose = FALSE, 
                          random.seed = 629)
```

## Visualization

First we visualize the semi-supervised clustering we've generated using Louvain modularity optimization. 

```{r}
p0 <- DimPlot(primary_orig) + 
      labs(x = "UMAP 1", y = "UMAP 2", title = "Primary Tumors") + 
      scale_color_paletteer_d("ggthemes::Classic_20") + 
      theme_yehlab() + 
      theme(text = element_text(family = "Avenir"), 
            axis.title = element_text(hjust = 0, size = 10), 
            plot.title = element_text(face = "bold", hjust = 0.5, size = 12)) + 
      guides(color = guide_legend(nrow = 2, override.aes = list(size = 3)))
p1 <- DimPlot(meta_orig) + 
      labs(title = "Metastatic Tumors") + 
      scale_color_paletteer_d("ggthemes::Classic_20") + 
      theme_yehlab() + 
      theme(axis.title = element_blank(), 
            text = element_text(family = "Avenir"), 
            plot.title = element_text(face = "bold", hjust = 0.5, size = 12)) + 
      guides(color = guide_legend(nrow = 2, override.aes = list(size = 3)))



(p0 | p1) + plot_annotation(caption = "Louvain Clustering", 
                            theme = theme(plot.caption = element_text(face = "italic")))
```

Next we check out how the samples are arranged in UMAP space. We see that there is next to no grouping by sample, which tells us that the data integration process worked correctly and the sample-related batch effect has been regressed out. 

```{r}
p2 <- DimPlot(primary_orig, group.by = "sample") + 
      labs(x = "UMAP 1", y = "UMAP 2", title = "Sample IDs (Primary Tumors)") + 
      scale_color_paletteer_d("miscpalettes::pastel") + 
      theme_yehlab() + 
      theme(text = element_text(family = "Avenir"), 
            axis.title = element_text(hjust = 0, size = 10), 
            plot.title = element_text(face = "bold", hjust = 0.5, size = 12)) + 
      guides(color = guide_legend(nrow = 2, override.aes = list(size = 3)))
p3 <- DimPlot(meta_orig, group.by = "sample") + 
      labs(title = "Sample IDs (Metastatic Tumors)") + 
      scale_color_paletteer_d("miscpalettes::pastel") + 
      theme_yehlab() + 
      theme(axis.title = element_blank(), text = element_text(family = "Avenir"), 
            plot.title = element_text(face = "bold", hjust = 0.5, size = 12)) + 
      guides(color = guide_legend(nrow = 2, override.aes = list(size = 3)))
(p2 | p3) + plot_annotation(theme = theme(plot.caption = element_text(face = "italic")))
```

# Analysis 